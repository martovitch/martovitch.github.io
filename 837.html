<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>837</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --terminal-green: #00A800; /* Приглушенный зеленый цвет для всего интерфейса */
        }
        body {
            font-family: 'Inter', monospace;
            background-color: #000; /* Черный фон */
            color: var(--terminal-green); /* Единый зеленый цвет текста для всего интерфейса */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Предотвратить прокрутку страницы */
        }
        .terminal-container {
            width: 100%;
            max-width: 800px;
            background-color: #000; /* Черный фон контейнера */
            display: flex;
            flex-direction: column;
            height: 70vh;
            border: none; /* Убран border для более простого дизайна */
            border-radius: 0; /* Убран border-radius */
        }
        .terminal-output {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* leading-relaxed */
            white-space: pre-wrap;
            scrollbar-width: none; /* Для Firefox */
            -ms-overflow-style: none; /* Для IE и Edge */
        }
        .terminal-output::-webkit-scrollbar {
            display: none; /* Для Chrome, Safari, Opera */
        }
        .terminal-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
        }
        .terminal-prompt {
            color: var(--terminal-green); /* Единый зеленый цвет для знака > */
            margin-right: 0.5rem;
        }
        /* Новый контейнер для визуального отображения ввода */
        #visual-input-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: transparent;
            color: var(--terminal-green); /* Единый зеленый цвет текста для отображения ввода */
        }
        .terminal-actual-input {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            color: transparent; /* Сделать текст невидимым */
            caret-color: transparent; /* Сделать курсор невидимым */
            z-index: 10;
            outline: none;
            border: none;
            font-family: 'Inter', monospace; /* Убедиться, что шрифт соответствует */
            font-size: 0.875rem; /* Соответствует output */
            text-transform: uppercase; /* Отображать ввод в верхнем регистре в поле input */
            padding-left: calc(1rem + 0.5rem); /* Padding для > и margin-right */
        }
        .blinking-cursor {
            width: 8px; /* w-2 */
            height: 16px; /* h-4 */
            background-color: var(--terminal-green); /* Единый зеленый цвет для мигающего курсора */
            margin-left: 2px; /* ml-0.5 */
            animation: blink-cursor 1s step-end infinite;
            display: inline-block; /* Убедиться, что он отображается как блок */
        }
        @keyframes blink-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-black font-mono">
    <div class="terminal-container">
        <div id="terminal-output" class="terminal-output">
            <!-- ЗДЕСЬ БУДЕТ ВЫВОДИТЬСЯ ИСТОРИЯ КОМАНД И ОТВЕТОВ -->
        </div>

        <div class="terminal-input-wrapper">
            <span class="terminal-prompt">&gt;</span>
            <div id="visual-input-area" class="flex-grow flex items-center">
                <span id="text-before-cursor" class="whitespace-pre"></span>
                <span id="user-cursor" class="blinking-cursor"></span>
                <span id="text-after-cursor" class="whitespace-pre"></span>
            </div>
            <input type="text" id="terminal-actual-input" class="terminal-actual-input" autofocus>
        </div>
    </div>

    <script>
        const terminalOutput = document.getElementById('terminal-output');
        const visualInputArea = document.getElementById('visual-input-area');
        const textBeforeCursorSpan = document.getElementById('text-before-cursor');
        const textAfterCursorSpan = document.getElementById('text-after-cursor');
        const userCursor = document.getElementById('user-cursor');
        const terminalActualInput = document.getElementById('terminal-actual-input');

        let inputValue = '';
        let outputHistory = [];
        let typingText = ''; // Текст, который компьютер печатает в данный момент
        let linesToTypeQueue = []; // Очередь строк для печати компьютером
        let isTypingResponse = false; // Флаг, печатает ли компьютер ответ
        let accessGranted = false; // Флаг доступа
        let inboxMessages = []; // Входящие сообщения
        let commsLog = []; // Журнал всех коммуникаций
        let commandHistory = []; // История введенных команд
        let commandHistoryIndex = -1; // Текущий индекс в истории команд (-1 означает ввод новой команды)
        let expeditionSentToLab = false; // Флаг: была ли отправлена экспедиция в скрытую лабораторию
        let secretSignalFrequency = '14.500'; // Частота для пеленга секретного сигнала
        const SECRET_LAB_COORDS = '62.193S, 58.891W'; // Координаты скрытой лаборатории

        let freyRequestForBearingSent = false; // Флаг: Центр запросил связаться с Фрей
        let bellingshausenBearingReceived = false; // Пеленг с базы Беллинсгаузен получен
        let freyBearingReceived = false; // Пеленг от Фрей получен

        const CORRECT_CODE = '837';
        const TYPING_SPEED = 6; // мс на символ (ускорен в 2 раза)

        // ===========================================
        // ПАРАМЕТРЫ ЭНЕРГОСИСТЕМЫ
        // ===========================================
        let activeGenerator = '1';
        let generatorFuel = { '1': 100, '2': 100, '3': 100 }; // В процентах
        const generatorCapacity = { '1': 200, '2': 250, '3': 300 }; // Максимальная мощность в КВТ
        let powerConsumption = 180; // Текущее потребление в КВТ
        const FUEL_CONSUMPTION_RATE = 0.05; // Процент топлива в секунду для активного генератора
        // ===========================================

        // ===========================================
        // ПАРАМЕТРЫ ПОГОДНОГО API (OPEN-METEO)
        // ===========================================
        const LATITUDE = -62.193; // Широта Беллинсгаузен
        const LONGITUDE = -58.891; // Долгота Беллинсгаузен
        const OPENMETEO_CURRENT_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LATITUDE}&longitude=${LONGITUDE}&current_weather=true&temperature_unit=celsius&windspeed_unit=ms&timezone=auto&forecast_days=1`;
        const OPENMETEO_HOURLY_URL = `https://api.open-meteo.com/v1/forecast?latitude=${LATITUDE}&longitude=${LONGITUDE}&hourly=temperature_2m,weathercode,windspeed_10m,winddirection_10m&temperature_unit=celsius&windspeed_unit=ms&timezone=auto&forecast_days=1`;
        // ===========================================


        // ASCII-карта местности (начальная версия без неопознанного объекта и сигнала)
        const MAP_ASCII_INITIAL = `
+----------------------------------------------------------------+
|  С (N)                                                         |
| ~~~~~~~  ПОБЕРЕЖЬЕ  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
| ~                                                              ~|
| ~  [Б]                                                         ~|
| ~                                                              ~|
| ~   ...............................................            ~|
| ~   . ФИЛЬДЕС П-ОВ . ^^^^^^^ ГОРЫ/ЛЕДНИКИ ^^^^^^^ . [Ф]           ~|
| ~   . . . . . . . . . . . . . . . . . . . . . . . .            ~|
| ~   . . . . . . . . . . . . . . . . . . . . . . . . .          ~|
| ~   ...............................................            ~|
| ~                                                              ~|
| ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
|  Ю (S)                                                         |
+----------------------------------------------------------------+
        |--- 1 КМ ---| (10 СИМВОЛОВ ≈ 1 КМ)
`;

        // ASCII-карта местности (версия с обнаруженным неопознанным объектом)
        const MAP_ASCII_REVEALED = `
+----------------------------------------------------------------+
|  С (N)                                                         |
| ~~~~~~~  ПОБЕРЕЖЬЕ  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
| ~                                                              ~|
| ~  [Б]                                                         ~|
| ~                                                              ~|
| ~   ...............................................            ~|
| ~   . ФИЛЬДЕС П-ОВ . ^^^^^^^ ГОРЫ/ЛЕДНИКИ ^^^^^^^ . [Ф]           ~|
| ~   . . . . . . . . . . . . . . . . . . . . . . . .            ~|
| ~   ...........................                                ~|
| ~   . . . . . . . . . . . . . . . [Н]                          ~|
| ~   ...............................................            ~|
| ~                                                              ~|
| ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|
|  Ю (S)                                                         |
+----------------------------------------------------------------+
        |--- 1 КМ ---| (10 СИМВОЛОВ ≈ 1 КМ)
`;

        // ===========================================
        // ДАННЫЕ ДОСЬЕ ПЕРСОНАЛА
        // ===========================================
        const personnelDossiers = {
            'АЛЕКСЕЕВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: АЛЕКСЕЕВ ИВАН ПЕТРОВИЧ
ДАТА РОЖДЕНИЯ: 12.03.1925
ДОЛЖНОСТЬ: РУКОВОДИТЕЛЬ СТАНЦИИ
ОБРАЗОВАНИЕ: ЛЕНИНГРАДСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ, ФАКУЛЬТЕТ ГЕОГРАФИИ (1949 Г.)
ОПЫТ РАБОТЫ: УЧАСТНИК ТРЕХ СОВЕТСКИХ АНТАРКТИЧЕСКИХ ЭКСПЕДИЦИЙ, РУКОВОДИТЕЛЬ ЗИМОВОК НА СТАНЦИЯХ ВОСТОК И МИРНЫЙ. ПРИЗНАННЫЙ ЭКСПЕРТ ПО ПОЛЯРНЫМ ИССЛЕДОВАНИЯМ.
НАГРАДЫ/ОТМЕТКИ: ОРДЕН "ЗНАК ПОЧЕТА", МЕДАЛЬ "ЗА ОСВОЕНИЕ ЦЕЛИННЫХ ЗЕМЕЛЬ".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ОБЛАДАЕТ ВЫСОКИМИ ОРГАНИЗАТОРСКИМИ СПОСОБНОСТЯМИ, СПОКОЙСТВИЕМ И ВЫДЕРЖКОЙ В КРИЗИСНЫХ СИТУАЦИЯХ. ПОЛЬЗУЕТСЯ АВТОРИТЕТОМ СРЕДИ ПЕРСОНАЛА. СКЛОНЕН К ПЕРФЕКЦИОНИЗМУ В НАУЧНЫХ ИССЛЕДОВАНИЯХ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: СИЛЬНЫЙ ЛИДЕР, МОТИВИРОВАННЫЙ, УСТОЙЧИВ К СТРЕССУ. ВЫСОКАЯ ПРИВЕРЖЕННОСТЬ ЦЕЛЯМ ЭКСПЕДИЦИИ.
            `.trim(),
            'СИДОРОВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: СИДОРОВ ОЛЕГ ВАСИЛЬЕВИЧ
ДАТА РОЖДЕНИЯ: 21.07.1930
ДОЛЖНОСТЬ: ГЛАВНЫЙ ИНЖЕНЕР
ОБРАЗОВАНИЕ: МОСКОВСКИЙ ЭНЕРГЕТИЧЕСКИЙ ИНСТИТУТ (1954 Г.)
ОПЫТ РАБОТЫ: УЧАСТВОВАЛ В ПРОЕКТИРОВАНИИ И ВВОДЕ В ЭКСПЛУАТАЦИЮ ЭНЕРГЕТИЧЕСКИХ СИСТЕМ НА НЕСКОЛЬКИХ СЕВЕРНЫХ И ПОЛЯРНЫХ СТАНЦИЯХ.
НАГРАДЫ/ОТМЕТКИ: ЗНАК "ОТЛИЧНИК ЭНЕРГЕТИКИ СССР".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ИСКЛЮЧИТЕЛЬНО ТЕХНИЧЕСКИ ПОДКОВАН. СПОСОБЕН РЕШАТЬ САМЫЕ СЛОЖНЫЕ ПРОБЛЕМЫ С ОБОРУДОВАНИЕМ В ЭКСТРЕМАЛЬНЫХ УСЛОВИЯХ. ЧАСТО РАБОТАЕТ В ОДИНОЧКУ В РАДИОРУБКЕ, ПОДДЕРЖИВАЯ СВЯЗЬ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: СПОКОЕН, МЕТОДИЧЕН, ОЧЕНЬ ОТВЕТСТВЕННЫЙ. ЦЕНИТ ТИШИНУ И КОНЦЕНТРАЦИЮ.
            `.trim(),
            'КОЗЛОВА': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: КОЗЛОВА ИРИНА МИХАЙЛОВНА
ДАТА РОЖДЕНИЯ: 05.11.1935
ДОЛЖНОСТЬ: МЕТЕОРОЛОГ
ОБРАЗОВАНИЕ: ЛЕНИНГРАДСКИЙ ГИДРОМЕТЕОРОЛОГИЧЕСКИЙ ИНСТИТУТ (1959 Г.)
ОПЫТ РАБОТЫ: РАБОТАЛА В ГИДРОМЕТЦЕНТРЕ СССР. ЭКСПЕРТ ПО АТМОСФЕРНЫМ ЯВЛЕНИЯМ В ВЫСОКИХ ШИРОТАХ. ПЕРВАЯ ЖЕНЩИНА-МЕТЕОРОЛОГ НА ДАННОЙ СТАНЦИИ.
НАГРАДЫ/ОТМЕТКИ: НАГРАДА "ЗА БЕЗУПРЕЧНУЮ СЛУЖБУ В ГИДРОМЕТСЛУЖБЕ".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ВЫСОКАЯ ТОЧНОСТЬ В ПРОГНОЗАХ, ВНИМАТЕЛЬНОСТЬ К ДЕТАЛЯМ. ИНОГДА ЧЕРЕСЧУР СЕРЬЕЗНА И СКРЫТНА. НАБЛЮДАЕТ НЕОБЫЧНЫЕ АТМОСФЕРНЫЕ ЯВЛЕНИЯ, СВЯЗАННЫЕ С СИГНАЛОМ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ИНТЕЛЛЕКТУАЛ, ПЕРФЕКЦИОНИСТ. МОЖЕТ ПРОЯВЛЯТЬ ТРЕВОЖНОСТЬ В НЕСТАНДАРТНЫХ СИТУАЦИЯХ.
            `.trim(),
            'СМИРНОВА': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: СМИРНОВА ОЛЬГА НИКОЛАЕВНА
ДАТА РОЖДЕНИЯ: 19.01.1932
ДОЛЖНОСТЬ: ВРАЧ
ОБРАЗОВАНИЕ: 1-Й МОСКОВСКИЙ МЕДИЦИНСКИЙ ИНСТИТУТ (1956 Г.)
ОПЫТ РАБОТЫ: РАБОТАЛА В ПОЛЕВЫХ ГОСПИТАЛЯХ И СЕВЕРНЫХ ЭКСПЕДИЦИЯХ. СПЕЦИАЛИЗИРУЕТСЯ НА ВЛИЯНИИ ЭКСТРЕМАЛЬНЫХ УСЛОВИЙ НА ОРГАНИЗМ ЧЕЛОВЕКА.
НАГРАДЫ/ОТМЕТКИ: МЕДАЛЬ "ЗА ТРУДОВУЮ ДОБЛЕСТЬ".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ОТЗЫВЧИВАЯ, СПОКОЙНАЯ, ВСЕГДА ГОТОВА ОКАЗАТЬ ПОМОЩЬ. ПОДДЕРЖИВАЕТ МОРАЛЬНЫЙ ДУХ КОМАНДЫ. ИМЕЕТ ОПЫТ В НЕСТАНДАРТНЫХ МЕДИЦИНСКИХ СИТУАЦИЯХ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ЭМПАТИЧНА, СТРЕССОУСТОЙЧИВА. ВЫСОКАЯ ПРИСПОСОБЛЯЕМОСТЬ К СЛОЖНЫМ УСЛОВИЯМ.
            `.trim(),
            'КУЗНЕЦОВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: КУЗНЕЦОВ АЛЕКСЕЙ ГРИГОРЬЕВИЧ
ДАТА РОЖДЕНИЯ: 08.09.1938
ДОЛЖНОСТЬ: ОПЕРАТОР РАДИОЦЕНТРА
ОБРАЗОВАНИЕ: ЛЕНИНГРАДСКИЙ ЭЛЕКТРОТЕХНИЧЕСКИЙ ИНСТИТУТ СВЯЗИ (1962 Г.)
ОПЫТ РАБОТЫ: СЛУЖИЛ В РАДИОВОЙСКАХ, РАБОТАЛ НА РАДИОСТАНЦИЯХ ДАЛЬНЕЙ СВЯЗИ.
НАГРАДЫ/ОТМЕТКИ: МЕДАЛЬ "ЗА ОТЛИЧИЕ В ВОИНСКОЙ СЛУЖБЕ".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ИСКЛЮЧИТЕЛЬНО ВНИМАТЕЛЕН И УСИДЧИВ. СПОСОБЕН "ВЫТЯГИВАТЬ" САМЫЕ СЛАБЫЕ СИГНАЛЫ. ЧАСТО ВЕЧЕРАМИ ЛОВИТ ЛЮБИТЕЛЬСКИЕ РАДИОПЕРЕДАЧИ ИЗ ДОМА.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ТИХИЙ, КОНЦЕНТРИРОВАННЫЙ. МОЖЕТ ПРОЯВЛЯТЬ ИЗОБРЕТАТЕЛЬНОСТЬ В РЕШЕНИИ ТЕХНИЧЕСКИХ ЗАДАЧ.
            `.trim(),
            'ИВАНОВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: ИВАНОВ ПЕТР СЕРГЕЕВИЧ
ДАТА РОЖДЕНИЯ: 15.04.1928
ДОЛЖНОСТЬ: ГЛЯЦИОЛОГ
ОБРАЗОВАНИЕ: МОСКОВСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ, ГЕОЛОГИЧЕСКИЙ ФАКУЛЬТЕТ (1951 Г.)
ОПЫТ РАБОТЫ: ВЕДУЩИЙ СПЕЦИАЛИСТ ПО ЛЬДАМ И ЛЕДНИКАМ. УЧАСТВОВАЛ В ИССЛЕДОВАНИЯХ АРКТИКИ И АНТАРКТИКИ. ОТВЕЧАЕТ ЗА БУРЕНИЕ ЛЕДОВЫХ СКВАЖИН.
НАГРАДЫ/ОТМЕТКИ: НАГРАДА "ПОЧЕТНЫЙ ПОЛЯРНИК".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: УМНЫЙ, НО УВЛЕЧЕННЫЙ ИНОГДА ДО ЗАБВЕНИЯ. СКЛОНЕН К РИСКОВАННЫМ ИССЛЕДОВАНИЯМ. В ПОСЛЕДНЕЕ ВРЕМЯ ЗАМЕЧЕН ЗА ИНТЕНСИВНЫМ ИЗУЧЕНИЕМ КАРТ МЕСТНОСТИ В НЕОБЫЧНЫХ РАЙОНАХ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ИССЛЕДОВАТЕЛЬ, СТРАСТНЫЙ В УВЛЕЧЕНИЯХ. МОЖЕТ БЫТЬ ОТРЫВАН ОТ РЕАЛЬНОСТИ В ПОИСКАХ НАУЧНЫХ ОТКРЫТИЙ.
            `.trim(),
            'МОРОЗОВА': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: МОРОЗОВА ЕЛЕНА АНДРЕЕВНА
ДАТА РОЖДЕНИЯ: 03.12.1939
ДОЛЖНОСТЬ: БИОЛОГ
ОБРАЗОВАНИЕ: ЛЕНИНГРАДСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ, БИОЛОГИЧЕСКИЙ ФАКУЛЬТЕТ (1963 Г.)
ОПЫТ РАБОТЫ: МОЛОДОЙ, НО ПЕРСПЕКТИВНЫЙ СПЕЦИАЛИСТ ПО МОРСКОЙ ФЛОРЕ И ФАУНЕ АНТАРКТИКИ. ЕЕ ПЕРВАЯ КРУПНАЯ ЭКСПЕДИЦИЯ.
НАГРАДЫ/ОТМЕТКИ: (ОТМЕТОК ПОКА НЕТ)
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ЭНТУЗИАСТ, ОЧЕНЬ ЛЮБИТ СВОЮ РАБОТУ. ИНОГДА ИЗЛИШНЕ ЭМОЦИОНАЛЬНА, НО БЫСТРО ПРИХОДИТ В СЕБЯ. ЗАМЕЧАЕТ МАЛЕЙШИЕ ИЗМЕНЕНИЯ В ОКРУЖАЮЩЕЙ СРЕДЕ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ЖИЗНЕРАДОСТНА, ЛЮБОЗНАТЕЛЬНА. ЛЕГКО АДАПТИРУЕТСЯ К НОВЫМ УСЛОВИЯМ.
            `.trim(),
            'НИКОЛАЕВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: НИКОЛАЕВ ВЛАДИМИР ПЕТРОВИЧ
ДАТА РОЖДЕНИЯ: 29.06.1927
ДОЛЖНОСТЬ: ГЕОЛОГ
ОБРАЗОВАНИЕ: ГОРНЫЙ ИНСТИТУТ, СВЕРДЛОВСК (1950 Г.)
ОПЫТ РАБОТЫ: ВЕТЕРАН ПОЛЕВЫХ РАБОТ НА УРАЛЕ И В СИБИРИ. СПЕЦИАЛИСТ ПО МИНЕРАЛОГИИ И СТРОЕНИЮ ЗЕМНОЙ КОРЫ.
НАГРАДЫ/ОТМЕТКИ: МЕДАЛЬ "ЗА ОТКРЫТИЕ НОВЫХ МЕСТОРОЖДЕНИЙ".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: НАСТОЙЧИВ, ТЕРПЕЛИВ. МНОГО ЧИТАЕТ И ВЕДЕТ ЗАПИСИ. СТАРАЕТСЯ СИСТЕМАТИЗИРОВАТЬ ДАННЫЕ О СТРАННЫХ ГЕОЛОГИЧЕСКИХ АНОМАЛИЯХ, ВЫЯВЛЕННЫХ НА ОСТРОВЕ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: УРАВНОВЕШЕН, СКРУПУЛЕЗЕН. ВЫСОКАЯ УСТОЙЧИВОСТЬ К МОНОТОННОЙ РАБОТЕ.
            `.trim(),
            'ВОЛКОВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: ВОЛКОВ РУСЛАН ДЕНИСОВИЧ
ДАТА РОЖДЕНИЯ: 10.10.1942
ДОЛЖНОСТЬ: ТЕХНИК
ОБРАЗОВАНИЕ: ПРОФЕССИОНАЛЬНО-ТЕХНИЧЕСКОЕ УЧИЛИЩЕ №7 (1960 Г.)
ОПЫТ РАБОТЫ: ОПЫТ РАБОТЫ ПО НАСТРОЙКЕ И РЕМОНТУ РАЗЛИЧНОГО ОБОРУДОВАНИЯ. МОЛОДОЙ, ЭНЕРГИЧНЫЙ.
НАГРАДЫ/ОТМЕТКИ: (ОТМЕТОК ПОКА НЕТ)
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ЗОЛОТЫЕ РУКИ, БЫСТРО УЧИТСЯ. НЕМНОГО БЕЗРАССУДЕН В СВОИХ ПОСТУПКАХ, ИНОГДА ПРЕВЫШАЕТ ПОЛНОМОЧИЯ В ДОСТУПЕ К ОБОРУДОВАНИЮ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ИМПУЛЬСИВНЫЙ, ЛЮБОПЫТНЫЙ. СКЛОНЕН К ПРИКЛЮЧЕНИЯМ.
            `.trim(),
            'БОРИСОВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: БОРИСОВ ЛЕОНИД ФЕДОРОВИЧ
ДАТА РОЖДЕНИЯ: 25.02.1937
ДОЛЖНОСТЬ: ТЕХНИК
ОБРАЗОВАНИЕ: ТЕХНИКУМ СВЯЗИ (1957 Г.)
ОПЫТ РАБОТЫ: ОПЫТНЫЙ СПЕЦИАЛИСТ ПО ЭЛЕКТРОННЫМ СИСТЕМАМ. ОТВЕТСТВЕННЫЙ И АККУРАТНЫЙ.
НАГРАДЫ/ОТМЕТКИ: (ОТМЕТОК ПОКА НЕТ)
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ТИХИЙ, ИСПОЛНИТЕЛЬНЫЙ. ПРЕДПОЧИТАЕТ РАБОТАТЬ ПО СТРОГИМ ИНСТРУКЦИЯМ. ЧАСТО ПРОВЕРЯЕТ НАДЕЖНОСТЬ ВСЕХ СИСТЕМ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ПОРЯДОЧНЫЙ, НАДЕЖНЫЙ. СЛОЖНО АДАПТИРУЕТСЯ К ВНЕЗАПНЫМ ИЗМЕНЕНИЯМ.
            `.trim(),
            'ГРИГОРЬЕВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: ГРИГОРЬЕВ СТЕПАН ЮРЬЕВИЧ
ДАТА РОЖДЕНИЯ: 07.08.1940
ДОЛЖНОСТЬ: ТЕХНИК
ОБРАЗОВАНИЕ: АВТОМЕХАНИЧЕСКИЙ ТЕХНИКУМ (1959 Г.)
ОПЫТ РАБОТЫ: СПЕЦИАЛИСТ ПО РЕМОНТУ ТРАНСПОРТА И ТЯЖЕЛОЙ ТЕХНИКИ.
НАГРАДЫ/ОТМЕТКИ: (ОТМЕТОК ПОКА НЕТ)
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ВЕСЕЛЫЙ, ОБЩИТЕЛЬНЫЙ. ЛЮБИТ РАССКАЗЫВАТЬ АНЕКДОТЫ. ПОДДЕРЖИВАЕТ ХОРОШЕЕ НАСТРОЕНИЕ В КОМАНДЕ. МАСТЕР НА ВСЕ РУКИ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ЭКСТРОВЕРТ, ОПТИМИСТ. ОТЛИЧНЫЙ КОМАНДНЫЙ ИГРОК.
            `.trim(),
            'АФАНАСЬЕВА': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: АФАНАСЬЕВА ГАЛИНА ВАСИЛЬЕВНА
ДАТА РОЖДЕНИЯ: 14.02.1933
ДОЛЖНОСТЬ: ПОВАР
ОБРАЗОВАНИЕ: КУЛИНАРНОЕ УЧИЛИЩЕ (1951 Г.)
ОПЫТ РАБОТЫ: РАБОТАЛА В ВЕДОМСТВЕННЫХ СТОЛОВЫХ И НА СЕВЕРНЫХ ГЕОЛОГОРАЗВЕДОЧНЫХ БАЗАХ.
НАГРАДЫ/ОТМЕТКИ: ЗНАК "ВЕТЕРАН ТРУДА".
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: ЗАБОТЛИВАЯ, НО СТРОГАЯ. ГЛАВНЫЙ АВТОРИТЕТ НА КУХНЕ. УМЕЕТ ПРИГОТОВИТЬ ВКУСНЫЕ БЛЮДА ИЗ СКРОМНЫХ ЗАПАСОВ. ИНОГДА ВЫСКАЗЫВАЕТ СВОИ ПОДОЗРЕНИЯ О ПРОИСХОДЯЩЕМ, ЧАСТО БЫВАЕТ ПРАВА.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: ПРАКТИЧНА, ВНИМАТЕЛЬНА. СКЛОННА К "БАБУШКИНЫМ" СОВЕТАМ.
            `.trim(),
            'ЗАХАРОВ': `
ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО: ЗАХАРОВ ДМИТРИЙ АНДРЕЕВИЧ
ДАТА РОЖДЕНИЯ: 01.06.1941
ДОЛЖНОСТЬ: ВОДИТЕЛЬ/МЕХАНИК
ОБРАЗОВАНИЕ: АВТОТРАНСПОРТНЫЙ ТЕХНИКУМ (1961 Г.)
ОПЫТ РАБОТЫ: СЛУЖИЛ В АВТОМОБИЛЬНЫХ ВОЙСКАХ. ОПЫТНЫЙ ВОДИТЕЛЬ В СЛОЖНЫХ УСЛОВИЯХ, ЗНАЕТ КАЖДЫЙ ДВИГАТЕЛЬ.
НАГРАДЫ/ОТМЕТКИ: (ОТМЕТОК ПОКА НЕТ)
ОСОБЫЕ КАЧЕСТВА/ЗАМЕЧАНИЯ: НЕМНОГОСЛОВЕН, ДЕЛАЕТ СВОЮ РАБОТУ. ОТЛИЧНО ОРИЕНТИРУЕТСЯ НА МЕСТНОСТИ, НЕЗАМЕНИМ В ЭКСПЕДИЦИЯХ. ИМЕЕТ ОСОБЫЕ НАВЫКИ УПРАВЛЕНИЯ ВЕЗДЕХОДАМИ.
ПСИХОЛОГИЧЕСКИЙ ПРОФИЛЬ: СПОКОЙНЫЙ, РАССУДИТЕЛЬНЫЙ. ПРЕДПОЧИТАЕТ ДЕЙСТВИЯ СЛОВАМ.
            `.trim()
        };

        // ===========================================
        // КОМАНДНАЯ СТРУКТУРА
        // ===========================================
        let currentContext = 'ROOT'; // Текущий контекст команд
        const CONTEXT_MENU = {
            ROOT: `ДОСТУПНЫЕ КОМАНДЫ (ГЛАВНОЕ МЕНЮ):
[КО]Д [КОД_ДОСТУПА] - ВВОД КОДА ДОСТУПА
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ ТЕКУЩЕГО МЕНЮ
[СТ]АТУС - ОБЩИЙ СТАТУС СТАНЦИИ
[ВР]ЕМЯ - ТЕКУЩЕЕ ВРЕМЯ И ДАТА
[ПОГ]ОДА - МЕТЕОСВОДКА И ПРОГНОЗ
[ЭН]ЕРГИЯ - УПРАВЛЕНИЕ ЭНЕРГОСИСТЕМАМИ
[СВ]ЯЗЬ - УПРАВЛЕНИЕ РАДИОЦЕНТРОМ
[КА]РТА - ПРОСМОТР КАРТ МЕСТНОСТИ
[ПЕ]РСОНАЛ - ДАННЫЕ О ПЕРСОНАЛЕ
[ДА]ННЫЕ - ДОСТУП К АРХИВАМ ДАННЫХ
[ЭК]СПЕДИЦИЯ - УПРАВЛЕНИЕ ЭКСПЕДИЦИЯМИ
[ВЫ]ЙТИ - ЗАВЕРШИТЬ СЕАНС
            `.trim(),
            COMMS_MENU: `КОМАНДЫ ДЛЯ СВЯЗИ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ СВЯЗИ
[ЧА]СТОТА [МГЦ] - НАСТРОИТЬ ЧАСТОТУ
[СО]ОБЩЕНИЕ [КОМУ] [ТЕКСТ] - ОТПРАВИТЬ СООБЩЕНИЕ (КОМУ: ЦЕНТР/ФРЕЙ/ОБЩЕЕ)
[ПР]ИНЯТЬ - ПРИНЯТЬ ВХОДЯЩИЕ СООБЩЕНИЯ
[ЖУ]РНАЛ - ПРОСМОТР ЖУРНАЛА КОММУНИКАЦИЙ
[ФР]ЕЙ - ПЕРЕХОД В МЕНЮ СВЯЗИ С ФРЕЙ
[ПЕЛ]ЕНГ [ЧАСТОТА_МГЦ] - ОПРЕДЕЛИТЬ НАПРАВЛЕНИЕ НА ИСТОЧНИК СИГНАЛА С БАЗЫ БЕЛЛИНСГАУЗЕН
[ДЕ]КОДИРОВАТЬ - ДЕКОДИРОВАТЬ СООБЩЕНИЕ
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim(),
            FREY_MENU: `КОМАНДЫ ДЛЯ СВЯЗИ С ФРЕЙ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ СВЯЗИ
[ПЕЛ]ЕНГ [ЧАСТОТА_МГЦ] - ОПРЕДЕЛИТЬ НАПРАВЛЕНИЕ НА ИСТОЧНИК СИГНАЛА С БАЗЫ ФРЕЙ
[НА]ЗАД - ВЕРНУТЬСЯ В МЕНЮ СВЯЗИ
            `.trim(),
            POWER_MENU: `КОМАНДЫ ДЛЯ ЭНЕРГИИ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ ЭНЕРГИИ
[СТ]АТУС - ПОКАЗАТЬ СТАТУС ЭНЕРГОСИСТЕМ
[ПГ]ЕРЕКЛЮЧИТЬ ГЕНЕРАТОР [НОМЕР] - ПЕРЕКЛЮЧИТЬ ГЕНЕРАТОР (1/2/3)
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim(),
            WEATHER_MENU: `КОМАНДЫ ДЛЯ ПОГОДЫ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ ПОГОДЫ
[ТЕ]КУЩАЯ - ТЕКУЩИЕ МЕТЕОСВОДКИ
[ПРО]ГНОЗ - ПРОГНОЗ НА 24 ЧАСА
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim(),
            MAP_MENU: `КОМАНДЫ ДЛЯ КАРТЫ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ КАРТЫ
[ОБ]ЩАЯ - ПОКАЗАТЬ ОБЩУЮ КАРТУ МЕСТНОСТИ
[ЛАБ]ОРАТОРИЯ - ПОКАЗАТЬ МЕСТОПОЛОЖЕНИЕ НЕОПОЗНАННОГО ОБЪЕКТА
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim(),
            DATA_MENU: `КОМАНДЫ ДЛЯ ДАННЫХ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ ДАННЫХ
[БИ]ОЛОГИЯ - ДОСТУП К БИОЛОГИЧЕСКИМ ДАННЫМ
[ГЕО]ЛОГИЯ - ДОСТУП К ГЕОЛОГИЧЕСКИМ ОТЧЕТАМ
[ГЛЯ]ЦИОЛОГИЯ - ДОСТУП К ГЛЯЦИОЛОГИЧЕСКИМ ДАННЫМ
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim(),
            EXPEDITION_MENU: `КОМАНДЫ ДЛЯ ЭКСПЕДИЦИИ:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ ЭКСПЕДИЦИИ
[СТ]АТУС - ТЕКУЩИЙ СТАТУС ЭКСПЕДИЦИЙ
[МАР]ШРУТ [НОМЕР] - ПОКАЗАТЬ ИНФОРМАЦИЮ О МАРШРУТЕ
[ОТ]ПРАВИТЬ [КООРДИНАТЫ] - ОТПРАВИТЬ ЭКСПЕДИЦИЮ ПО КООРДИНАТАМ
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim(),
            PERSONNEL_MENU: `КОМАНДЫ ДЛЯ ПЕРСОНАЛА:
[ПО]МОЩЬ - СПИСОК КОМАНД ДЛЯ ПЕРСОНАЛА
[СП]ИСОК - ПОКАЗАТЬ СПИСОК ПЕРСОНАЛА
[ДО]СЬЕ [ФАМИЛИЯ] - ПРОСМОТР ДОСЬЕ НА СОТРУДНИКА (НАПРИМЕР, ДОСЬЕ АЛЕКСЕЕВ)
[НА]ЗАД - ВЕРНУТЬСЯ В ГЛАВНОЕ МЕНЮ
            `.trim()
        };

        // Функция для получения текущей временной метки
        function getTimestamp() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `[${hours}:${minutes}:${seconds}]`;
        }

        // Функция для прокрутки терминала до конца
        function scrollToBottom() {
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        // Функция для обновления отображения ввода пользователя и курсора
        function updateUserInputDisplay() {
            if (isTypingResponse) {
                userCursor.style.display = 'none';
                textBeforeCursorSpan.textContent = '';
                textAfterCursorSpan.textContent = '';
                return;
            }

            const cursorPosition = terminalActualInput.selectionStart;
            textBeforeCursorSpan.textContent = inputValue.substring(0, cursorPosition);
            textAfterCursorSpan.textContent = inputValue.substring(cursorPosition);
            userCursor.style.display = 'inline-block'; // Убедиться, что курсор пользователя виден

            scrollToBottom();
        }

        // Функция для добавления строки в историю вывода (без автоматической метки времени)
        function addLineToOutput(line) {
            const p = document.createElement('p');
            p.textContent = line.toUpperCase(); // Приводим к ВЕРХНЕМУ регистру
            p.className = 'mb-1';
            terminalOutput.appendChild(p);
            scrollToBottom();
        }

        // Функция для печати текста компьютером
        function typeComputerResponse() {
            if (linesToTypeQueue.length === 0) {
                isTypingResponse = false;
                updateUserInputDisplay(); // Показать курсор пользователя снова
                terminalActualInput.disabled = false; // Активировать поле ввода
                terminalActualInput.focus();
                return;
            }

            isTypingResponse = true;
            terminalActualInput.disabled = true; // Отключить ввод пользователя
            userCursor.style.display = 'none'; // Скрыть курсор пользователя
            
            const currentLineToType = linesToTypeQueue.shift(); // Берем первую строку из очереди
            let charIndex = 0;
            typingText = ''; // Сбрасываем текст для новой строки

            // Создаем временный элемент для отображения печатаемого текста и курсора
            const typingP = document.createElement('p');
            typingP.className = 'mb-1 flex items-center';
            const textSpan = document.createElement('span');
            textSpan.className = 'whitespace-pre';
            const cursorSpan = document.createElement('span');
            cursorSpan.className = 'w-2 h-4 blinking-cursor'; /* Используем класс для цвета курсора */
            typingP.appendChild(textSpan);
            typingP.appendChild(cursorSpan);
            terminalOutput.appendChild(typingP); // Добавляем в DOM

            const typingInterval = setInterval(() => {
                if (charIndex < currentLineToType.length) {
                    typingText += currentLineToType[charIndex].toUpperCase(); // Приводим к ВЕРХНЕМУ регистру
                    textSpan.textContent = typingText;
                    charIndex++;
                } else {
                    clearInterval(typingInterval);
                    
                    // Заменяем временный элемент полностью напечатанной строкой в истории
                    terminalOutput.removeChild(typingP);
                    addLineToOutput(currentLineToType); // addLineToOutput теперь НЕ добавляет временную метку
                    // После завершения текущей строки сразу запускаем печать следующей (если есть)
                    typeComputerResponse(); 
                }
                scrollToBottom();
            }, TYPING_SPEED);
        }

        // Функция для отправки ответа на печать
        function sendResponseToType(responseString) {
            linesToTypeQueue = responseString.split('\n');
            typeComputerResponse();
        }

        // Функция для мгновенной отправки ответа (используется для карты)
        function sendInstantResponseToOutput(responseString) {
            responseString.split('\n').forEach(line => {
                addLineToOutput(line); // addLineToOutput теперь НЕ добавляет временную метку
            });
            scrollToBottom();
            terminalActualInput.disabled = false; // Активировать поле ввода
            terminalActualInput.focus();
        }

        // ===========================================
        // Хелпер для сопоставления команд и сокращений
        // ===========================================
        function matchCommand(input, fullCommands, shortcuts) {
            // Проверяем точное совпадение с полным названием
            for (const fullCmd of fullCommands) {
                if (input === fullCmd || input.startsWith(fullCmd + ' ')) {
                    return fullCmd;
                }
            }
            // Проверяем точное совпадение с сокращением
            for (const shortcut of shortcuts) {
                if (input === shortcut || input.startsWith(shortcut + ' ')) {
                    return shortcut;
                }
            }
            return null;
        }

        // ===========================================
        // ФУНКЦИИ ДЛЯ ПОГОДНОГО API (OPEN-METEO)
        // ===========================================

        // Вспомогательная функция для преобразования WMO-кодов в описание
        function getWeatherDescription(code) {
            switch (code) {
                case 0: return 'ЯСНО';
                case 1: return 'ПРЕИМУЩЕСТВЕННО ЯСНО';
                case 2: return 'ПЕРЕМЕННАЯ ОБЛАЧНОСТЬ';
                case 3: return 'ПАСМУРНО';
                case 45: return 'ТУМАН';
                case 48: return 'ИЗМОРОЗЬ';
                case 51: return 'ЛЕГКИЙ ДОЖДЬ';
                case 53: return 'УМЕРЕННЫЙ ДОЖДЬ';
                case 55: return 'СИЛЬНЫЙ ДОЖДЬ';
                case 56: return 'ЛЕГКИЙ ЛЕДЯНОЙ ДОЖДЬ';
                case 57: return 'СИЛЬНЫЙ ЛЕДЯНОЙ ДОЖДЬ';
                case 61: return 'НЕБОЛЬШОЙ ДОЖДЬ';
                case 63: return 'УМЕРЕННЫЙ ДОЖДЬ';
                case 65: return 'СИЛЬНЫЙ ДОЖДЬ';
                case 66: return 'ЛЕГКИЙ ЛЕДЯНОЙ ДОЖДЬ';
                case 67: return 'СИЛЬНЫЙ ЛЕДЯНОЙ ДОЖДЬ';
                case 71: return 'НЕБОЛЬШОЙ СНЕГ';
                case 73: return 'УМЕРЕННЫЙ СНЕГ';
                case 75: return 'СИЛЬНЫЙ СНЕГ';
                case 77: return 'СНЕЖНЫЕ ЗЕРНА';
                case 80: return 'НЕБОЛЬШОЙ ЛИВЕНЬ';
                case 81: return 'УМЕРЕННЫЙ ЛИВЕНЬ';
                case 82: return 'СИЛЬНЫЙ ЛИВЕНЬ';
                case 85: return 'НЕБОЛЬШОЙ СНЕЖНЫЙ ЛИВЕНЬ';
                case 86: return 'СИЛЬНЫЙ СНЕЖНЫЙ ЛИВЕНЬ';
                case 95: return 'ГРОЗА';
                case 96: case 99: return 'ГРОЗА С ГРАДОМ';
                default: return 'НЕОПРЕДЕЛЕНО';
            }
        }

        async function fetchWeatherData(type = 'current') {
            const url = type === 'current' ? OPENMETEO_CURRENT_URL : OPENMETEO_HOURLY_URL;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`ОШИБКА HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                if (type === 'current') {
                    if (!data.current_weather) {
                        return 'НЕ УДАЛОСЬ ПОЛУЧИТЬ ТЕКУЩИЕ ПОГОДНЫЕ ДАННЫЕ.';
                    }
                    const currentWeather = data.current_weather;
                    const temp = currentWeather.temperature.toFixed(1);
                    const windSpeed = currentWeather.windspeed.toFixed(1);
                    const windDeg = currentWeather.winddirection;
                    const weatherCode = currentWeather.weathercode;
                    const description = getWeatherDescription(weatherCode);

                    let windDirectionText = '';
                    if (windDeg > 337.5 || windDeg <= 22.5) windDirectionText = 'С';
                    else if (windDeg > 22.5 && windDeg <= 67.5) windDirectionText = 'СВ';
                    else if (windDeg > 67.5 && windDeg <= 112.5) windDirectionText = 'В';
                    else if (windDeg > 112.5 && windDeg <= 157.5) windDirectionText = 'ЮВ';
                    else if (windDeg > 157.5 && windDeg <= 202.5) windDirectionText = 'Ю';
                    else if (windDeg > 202.5 && windDeg <= 247.5) windDirectionText = 'ЮЗ';
                    else if (windDeg > 247.5 && windDeg <= 292.5) windDirectionText = 'З';
                    else if (windDeg > 292.5 && windDeg <= 337.5) windDirectionText = 'СЗ';

                    return `ТЕКУЩИЕ МЕТЕОДАННЫЕ:
ТЕМПЕРАТУРА: ${temp}°C
ОПИСАНИЕ: ${description}
ВЕТЕР: ${windDirectionText} ${windSpeed} М/С`; // Open-Meteo не предоставляет влажность напрямую в current_weather
                } else { // Прогноз
                    if (!data.hourly) {
                        return 'НЕ УДАЛОСЬ ПОЛУЧИТЬ ДАННЫЕ ПРОГНОЗА.';
                    }
                    let forecastText = 'ПРОГНОЗ ПОГОДЫ НА 24 ЧАСА:\n';
                    const hourly = data.hourly;
                    
                    // Open-Meteo возвращает массивы для каждого параметра, индексированные по времени
                    for (let i = 0; i < Math.min(24, hourly.time.length); i++) { // Берем 24 часа
                        const date = new Date(hourly.time[i]);
                        const time = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        const temp = hourly.temperature_2m[i].toFixed(1);
                        const weatherCode = hourly.weathercode[i];
                        const description = getWeatherDescription(weatherCode);
                        const windSpeed = hourly.windspeed_10m[i].toFixed(1);
                        const windDeg = hourly.winddirection_10m[i];

                        let windDirectionText = '';
                        if (windDeg > 337.5 || windDeg <= 22.5) windDirectionText = 'С';
                        else if (windDeg > 22.5 && windDeg <= 67.5) windDirectionText = 'СВ';
                        else if (windDeg > 67.5 && windDeg <= 112.5) windDirectionText = 'В';
                        else if (windDeg > 112.5 && windDeg <= 157.5) windDirectionText = 'ЮВ';
                        else if (windDeg > 157.5 && windDeg <= 202.5) windDirectionText = 'Ю';
                        else if (windDeg > 202.5 && windDeg <= 247.5) windDirectionText = 'ЮЗ';
                        else if (windDeg > 247.5 && windDeg <= 292.5) windDirectionText = 'З';
                        else if (windDeg > 292.5 && windDeg <= 337.5) windDirectionText = 'СЗ';

                        forecastText += `${time}: ${temp}°C, ${description}, ${windDirectionText} ${windSpeed} М/С\n`;
                    }
                    return forecastText.trim();
                }

            } catch (error) {
                console.error('ОШИБКА ПРИ ЗАГРУЗКЕ ПОГОДНЫХ ДАННЫХ:', error);
                return 'НЕ УДАЛОСЬ ЗАГРУЗИТЬ ПОГОДНЫЕ ДАННЫЕ. ПРОВЕРЬТЕ СОЕДИНЕНИЕ С ИНТЕРНЕТОМ.';
            }
        }


        // ===========================================
        // ОБРАБОТЧИКИ КОМАНД
        // ===========================================

        async function handleRootCommand(command) { // Сделаем асинхронной
            let response = '';

            const fullCmd = command.split(' ')[0]; // Извлекаем только саму команду без аргументов

            // Команды с аргументами
            if (matchCommand(command, ['КОД'], ['КО'])) {
                const codeAttempt = command.substring(command.indexOf(' ') + 1).trim();
                if (codeAttempt === CORRECT_CODE) {
                    response = 'ДОСТУП РАЗРЕШЕН';
                    accessGranted = true;
                } else {
                    response = 'НЕВЕРНЫЙ КОД ДОСТУПА\nПОВТОРИТЕ ПОПЫТКУ';
                }
            }
            // Команды без аргументов
            else if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.ROOT;
            } else if (matchCommand(fullCmd, ['СТАТУС'], ['СТ'])) {
                // Обновленный статус с информацией об энергосистемах
                const currentCapacity = generatorCapacity[activeGenerator];
                const powerDeficit = powerConsumption > currentCapacity ? powerConsumption - currentCapacity : 0;
                const powerReserve = currentCapacity > currentCapacity ? currentCapacity - powerConsumption : 0;

                response = `
СТАТУС СТАНЦИИ БЕЛЛИНСГАУЗЕН:
ТЕКУЩЕЕ ПОТРЕБЛЕНИЕ: ${powerConsumption} КВТ.
АКТИВНЫЙ ГЕНЕРАТОР: ${activeGenerator} (МОЩНОСТЬ: ${generatorCapacity[activeGenerator]} КВТ).
ТОПЛИВО ГЕНЕРАТОРОВ:
  ГЕНЕРАТОР 1: ${generatorFuel['1'].toFixed(1)}% (МОЩНОСТЬ: ${generatorCapacity['1']} КВТ)
  ГЕНЕРАТОР 2: ${generatorFuel['2'].toFixed(1)}% (МОЩНОСТЬ: ${generatorCapacity['2']} КВТ)
  ГЕНЕРАТОР 3: ${generatorFuel['3'].toFixed(1)}% (МОЩНОСТЬ: ${generatorCapacity['3']} КВТ)
ЭНЕРГЕТИЧЕСКИЙ РЕЗЕРВ: ${powerReserve} КВТ.
${powerDeficit > 0 ? `ДЕФИЦИТ ЭНЕРГИИ: ${powerDeficit} КВТ. ВОЗМОЖНЫ СБОИ.` : ''}
ПЕРСОНАЛ: 13 ЧЕЛОВЕК НА БАЗЕ.
                `.trim();
            } else if (matchCommand(fullCmd, ['ВРЕМЯ'], ['ВР'])) {
                const now = new Date();
                const historicalDate = new Date(
                    1967,
                    now.getMonth(),
                    now.getDate(),
                    now.getHours(),
                    now.getMinutes(),
                    now.getSeconds()
                );
                response = `
ТЕКУЩЕЕ ВРЕМЯ НА СТАНЦИИ БЕЛЛИНСГАУЗЕН:
${historicalDate.toLocaleString('RU-RU', { timeZone: 'Antarctica/Syowa' }).toUpperCase()}
                `.trim();
            } else if (matchCommand(fullCmd, ['ПОГОДА'], ['ПОГ'])) {
                currentContext = 'WEATHER_MENU';
                response = CONTEXT_MENU.WEATHER_MENU;
            } else if (matchCommand(fullCmd, ['ЭНЕРГИЯ'], ['ЭН'])) {
                currentContext = 'POWER_MENU';
                response = CONTEXT_MENU.POWER_MENU;
            } else if (matchCommand(fullCmd, ['СВЯЗЬ'], ['СВ'])) {
                currentContext = 'COMMS_MENU';
                response = CONTEXT_MENU.COMMS_MENU;
            } else if (matchCommand(fullCmd, ['КАРТА'], ['КА'])) {
                // Переход в меню карты обрабатывается в processCommand
                // Здесь оставляем пустым, чтобы не было "НЕИЗВЕСТНАЯ КОМАНДА"
            } else if (matchCommand(fullCmd, ['ПЕРСОНАЛ'], ['ПЕ'])) {
                currentContext = 'PERSONNEL_MENU';
                response = CONTEXT_MENU.PERSONNEL_MENU;
            } else if (matchCommand(fullCmd, ['ДАННЫЕ'], ['ДА'])) {
                currentContext = 'DATA_MENU';
                response = CONTEXT_MENU.DATA_MENU;
            } else if (matchCommand(fullCmd, ['ЭКСПЕДИЦИЯ'], ['ЭК'])) {
                currentContext = 'EXPEDITION_MENU';
                response = CONTEXT_MENU.EXPEDITION_MENU;
            } else if (matchCommand(fullCmd, ['ВЫЙТИ'], ['ВЫ'])) {
                response = 'ЗАВЕРШЕНИЕ СЕАНСА. ДО СВИДАНИЯ.';
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }

            return response;
        }

        function handleCommsCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.COMMS_MENU;
            } else if (matchCommand(command, ['ЧАСТОТА'], ['ЧА'])) {
                const freq = command.substring(command.indexOf(' ') + 1).trim();
                if (freq && !isNaN(parseFloat(freq))) {
                    response = `ЧАСТОТА НАСТРОЕНА НА ${freq} МГЦ.`;
                    commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО: НАСТРОЙКА ЧАСТОТЫ ${freq} МГЦ`);
                } else {
                    response = 'НЕВЕРНЫЙ ФОРМАТ ЧАСТОТЫ. ПРИМЕР: ЧАСТОТА 14.280';
                }
            } else if (matchCommand(command, ['СООБЩЕНИЕ'], ['СО'])) {
                const parts = command.split(' ');
                if (parts.length < 3) {
                    response = 'НЕВЕРНЫЙ ФОРМАТ СООБЩЕНИЯ. ПРИМЕР: СООБЩЕНИЕ ЦЕНТР [ТЕКСТ]';
                    return response;
                }
                const recipient = parts[1];
                const messageContent = parts.slice(2).join(' ').trim();

                if (messageContent.length === 0) {
                    response = 'СООБЩЕНИЕ ПУСТОЕ. ПОЖАЛУЙСТА, ВВЕДИТЕ ТЕКСТ.';
                    return response;
                }

                if (recipient === 'ЦЕНТР') {
                    response = `СООБЩЕНИЕ В ЦЕНТР: "${messageContent}" ОТПРАВЛЕНО.\nПРИНЯТО`;
                    commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО В ЦЕНТР: "${messageContent}"`);
                } else if (recipient === 'ОБЩЕЕ') {
                    response = `СООБЩЕНИЕ: "${messageContent}" ОТПРАВЛЕНО.`;
                    commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО: "${messageContent}"`);
                } else if (recipient === 'ФРЕЙ') {
                    // Обработка сообщения Фрей, если это не пеленг.
                    // Для пеленга Фрей будет отдельная команда.
                    response = `СООБЩЕНИЕ ФРЕЙ: "${messageContent}" ОТПРАВЛЕНО.`;
                    commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО ФРЕЙ: "${messageContent}"`);
                }
                else {
                    response = 'НЕВЕРНЫЙ ПОЛУЧАТЕЛЬ. ДОСТУПНЫ: ЦЕНТР/ФРЕЙ/ОБЩЕЕ';
                }
            } else if (matchCommand(fullCmd, ['ПРИНЯТЬ'], ['ПР'])) {
                if (inboxMessages.length > 0) {
                    const newMessage = inboxMessages.shift();
                    response = `ПРИНЯТО СООБЩЕНИЕ:\n${newMessage}`; // newMessage уже содержит временную метку
                    commsLog.push(newMessage); // Добавляем сообщение в журнал как есть (уже с меткой)
                } else {
                    response = 'НЕТ ВХОДЯЩИХ СООБЩЕНИЙ.';
                }
            } else if (matchCommand(fullCmd, ['ЖУРНАЛ'], ['ЖУ'])) {
                if (commsLog.length > 0) {
                    response = 'ЖУРНАЛ КОММУНИКАЦИЙ:\n' + commsLog.slice(-10).join('\n');
                } else {
                    response = 'ЖУРНАЛ КОММУНИКАЦИЙ ПУСТ.';
                }
            } else if (matchCommand(fullCmd, ['ФРЕЙ'], ['ФР'])) {
                currentContext = 'FREY_MENU';
                response = CONTEXT_MENU.FREY_MENU;
            } else if (matchCommand(command, ['ПЕЛЕНГ'], ['ПЕЛ'])) { 
                if (!accessGranted) {
                    response = 'ТРЕБУЕТСЯ ДОСТУП ДЛЯ ИСПОЛЬЗОВАНИЯ ФУНКЦИИ ПЕЛЕНГАЦИИ.';
                } else {
                    const freqToPeleng = command.substring(command.indexOf(' ') + 1).trim(); 
                    if (freqToPeleng === secretSignalFrequency) {
                        response = `СИГНАЛ ОБНАРУЖЕН НА ЧАСТОТЕ ${secretSignalFrequency} МГЦ. ПЕЛЕНГ ОТ БЕЛЛИНСГАУЗЕН: ЮГО-ВОСТОК, 135 ГРАДУСОВ (±5).`;
                        commsLog.push(`${getTimestamp()} ПЕЛЕНГ С БАЗЫ БЕЛЛИНСГАУЗЕН: СИГНАЛ ${secretSignalFrequency}МГЦ, ЮГО-ВОСТОК.`);
                        bellingshausenBearingReceived = true; // Устанавливаем флаг для базы Беллинсгаузен
                        if (freyBearingReceived && bellingshausenBearingReceived) {
                            response += '\n\nДАННЫЕ ПЕЛЕНГАЦИИ С ДВУХ БАЗ ПОЛУЧЕНЫ. ВОЗМОЖНА ТРИАНГУЛЯЦИЯ. ПРОВЕРЬТЕ КАРТУ НА ПРЕДМЕТ НЕОПОЗНАННЫХ ОБЪЕКТОВ.';
                        }
                    } else if (!isNaN(parseFloat(freqToPeleng))) {
                        response = `НЕТ АКТИВНЫХ СИГНАЛОВ НА ЧАСТОТЕ ${freqToPeleng} МГЦ.`;
                    } else {
                        response = 'НЕВЕРНЫЙ ФОРМАТ ЧАСТОТЫ. ПРИМЕР: ПЕЛЕНГ 14.500';
                    }
                }
            } else if (matchCommand(fullCmd, ['ДЕКОДИРОВАТЬ'], ['ДЕ'])) {
                response = 'ТРЕБУЕТСЯ КОД ДЕШИФРОВКИ. ПРИМЕР: ДЕКОДИРОВАТЬ [КОДОВОЕ_СЛОВО]';
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ СВЯЗИ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }

        function handleFreyCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.FREY_MENU;
            } else if (matchCommand(command, ['ПЕЛЕНГ'], ['ПЕЛ'])) {
                const freqToPeleng = command.substring(command.indexOf(' ') + 1).trim(); 
                if (!accessGranted) { // Добавлена проверка доступа
                    response = 'ТРЕБУЕТСЯ ДОСТУП ДЛЯ ИСПОЛЬЗОВАНИЯ ФУНКЦИИ ПЕЛЕНГАЦИИ.';
                } else if (freqToPeleng === secretSignalFrequency) {
                    response = `СИГНАЛ ОБНАРУЖЕН НА ЧАСТОТЕ ${secretSignalFrequency} МГЦ. ПЕЛЕНГ ОТ ФРЕЙ: СЕВЕРО-ВОСТОК, 45 ГРАДУСОВ (±3).`;
                    commsLog.push(`${getTimestamp()} ПЕЛЕНГ С БАЗЫ ФРЕЙ: СИГНАЛ ${secretSignalFrequency}МГЦ, СЕВЕРО-ВОСТОК.`);
                    freyBearingReceived = true; // Устанавливаем флаг для базы Фрей
                    if (freyBearingReceived && bellingshausenBearingReceived) { // Проверяем, оба ли флага истинны
                        response += `\n\nДАННЫЕ ПЕЛЕНГАЦИИ С ДВУХ БАЗ ПОЛУЧЕНЫ. ВОЗМОЖНА ТРИАНГУЛЯЦИЯ. ПРОВЕРЬТЕ КАРТУ НА ПРЕДМЕТ НЕОПОЗНАННЫХ ОБЪЕКТОВ.`;
                    }
                } else if (!isNaN(parseFloat(freqToPeleng))) {
                    response = `НЕТ АКТИВНЫХ СИГНАЛОВ НА ЧАСТОТЕ ${freqToPeleng} МГЦ.`;
                } else {
                    response = 'НЕВЕРНЫЙ ФОРМАТ ЧАСТОТЫ. ПРИМЕР: ПЕЛЕНГ 14.500';
                }
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ ФРЕЙ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }

        function handlePowerCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.POWER_MENU;
            } else if (matchCommand(fullCmd, ['СТАТУС'], ['СТ'])) {
                const currentCapacity = generatorCapacity[activeGenerator];
                const powerDeficit = powerConsumption > currentCapacity ? powerConsumption - currentCapacity : 0;
                const powerReserve = currentCapacity > currentCapacity ? currentCapacity - powerConsumption : 0;

                response = `
СТАТУС ЭНЕРГОСИСТЕМ:
АКТИВНЫЙ ГЕНЕРАТОР: ${activeGenerator} (МОЩНОСТЬ: ${generatorCapacity[activeGenerator]} КВТ)
ТОПЛИВО: ${generatorFuel[activeGenerator].toFixed(1)}%
ГЕНЕРАТОРЫ:
  ГЕНЕРАТОР 1: ${generatorFuel['1'].toFixed(1)}% (МОЩНОСТЬ: ${generatorCapacity['1']} КВТ) ${activeGenerator === '1' ? '(АКТИВЕН)' : '(РЕЗЕРВ)'}
  ГЕНЕРАТОР 2: ${generatorFuel['2'].toFixed(1)}% (МОЩНОСТЬ: ${generatorCapacity['2']} КВТ) ${activeGenerator === '2' ? '(АКТИВЕН)' : '(РЕЗЕРВ)'}
  ГЕНЕРАТОР 3: ${generatorFuel['3'].toFixed(1)}% (МОЩНОСТЬ: ${generatorCapacity['3']} КВТ) ${activeGenerator === '3' ? '(АКТИВЕН)' : '(РЕЗЕРВ)'}
ТЕКУЩЕЕ ПОТРЕБЛЕНИЕ: ${powerConsumption} КВТ.
ОБЩАЯ МОЩНОСТЬ: ${currentCapacity} КВТ.
ЭНЕРГЕТИЧЕСКИЙ РЕЗЕРВ: ${powerReserve} КВТ.
${powerDeficit > 0 ? `ДЕФИЦИТ ЭНЕРГИИ: ${powerDeficit} КВТ. ВОЗМОЖНЫ СБОИ.` : ''}
                `.trim();
            } else if (matchCommand(command, ['ПЕРЕКЛЮЧИТЬ ГЕНЕРАТОР'], ['ПГ'])) {
                const parts = command.split(' ');
                const genNum = parts[parts.length - 1]; // Берем последний аргумент
                
                if (['1', '2', '3'].includes(genNum)) {
                    if (genNum === activeGenerator) {
                        response = `ГЕНЕРАТОР ${genNum} УЖЕ АКТИВЕН.`;
                    } else if (generatorFuel[genNum] <= 0) {
                        response = `НЕВОЗМОЖНО ПЕРЕКЛЮЧИТЬ НА ГЕНЕРАТОР ${genNum}: НЕТ ТОПЛИВА.`;
                    } else {
                        activeGenerator = genNum;
                        response = `ПЕРЕКЛЮЧЕНИЕ НА ГЕНЕРАТОР ${genNum}... УСПЕШНО.`;
                        commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО: ПЕРЕКЛЮЧЕНИЕ НА ГЕНЕРАТОР ${genNum}.`);
                    }
                } else {
                    response = 'НЕВЕРНЫЙ НОМЕР ГЕНЕРАТОРА. ДОСТУПНЫЕ: 1, 2, 3.';
                }
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ ЭНЕРГИИ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }
        
        async function handleWeatherCommand(command) { // Сделаем асинхронной
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.WEATHER_MENU;
            } else if (matchCommand(fullCmd, ['ТЕКУЩАЯ'], ['ТЕ'])) {
                response = await fetchWeatherData('current');
            } else if (matchCommand(fullCmd, ['ПРОГНОЗ'], ['ПРО'])) {
                response = await fetchWeatherData('forecast');
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ ПОГОДЫ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }

        function handleMapCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.MAP_MENU;
            } else if (matchCommand(fullCmd, ['ЛАБОРАТОРИЯ'], ['ЛАБ'])) {
                if (accessGranted && freyBearingReceived && bellingshausenBearingReceived) { // Оба флага должны быть истинны
                    response = `
МЕСТОПОЛОЖЕНИЕ НЕОПОЗНАННОГО ОБЪЕКТА:
КООРДИНАТЫ: ${SECRET_LAB_COORDS}
СИГНАЛ: ${secretSignalFrequency} МГЦ
ОРИЕНТИРОВОЧНО: В ГЛУБИНЕ ОСТРОВА, К ЮГО-ВОСТОКУ ОТ ОБЕИХ БАЗ, В РАЙОНЕ ЛЕДНИКОВ.
СМОТРИТЕ НА КАРТУ [Н].
                    `.trim();
                } else if (accessGranted && !(freyBearingReceived && bellingshausenBearingReceived)) {
                    response = 'ДОСТУП К ДАННЫМ РАЗРЕШЕН, НО ДЕТАЛИ НЕПОЛНЫЕ. ТРЕБУЕТСЯ БОЛЬШЕ ИНФОРМАЦИИ (ПЕЛЕНГ С ОБЕИХ БАЗ).';
                } else {
                    response = 'ДОСТУП К ДАННЫМ ЗАПРЕЩЕН.';
                }
            } else if (matchCommand(fullCmd, ['ОБЩАЯ'], ['ОБ'])) { 
                // Специальная обработка карты в processCommand
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ КАРТЫ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }

        function handlePersonnelCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.PERSONNEL_MENU;
            } else if (matchCommand(fullCmd, ['СПИСОК'], ['СП'])) {
                response = `
СОСТАВ ПЕРСОНАЛА СТАНЦИИ:
РУКОВОДИТЕЛЬ: АЛЕКСЕЕВ И.П.
ГЛАВНЫЙ ИНЖЕНЕР: СИДОРОВ О.В.
МЕТЕОРОЛОГ: КОЗЛОВА И.М.
ВРАЧ: СМИРНОВА О.Н.
РАДИОЦЕНТР: КУЗНЕЦОВ А.Г.
ГЛЯЦИОЛОГ: ИВАНОВ П.С.
БИОЛОГ: МОРОЗОВА Е.А.
ГЕОЛОГ: НИКОЛАЕВ В.П.
ТЕХНИК: ВОЛКОВ Р.Д.
ТЕХНИК: БОРИСОВ Л.Ф.
ТЕХНИК: ГРИГОРЬЕВ С.Ю.
ПОВАР: АФАНАСЬЕВА Г.В.
ВОДИТЕЛЬ/МЕХАНИК: ЗАХАРОВ Д.А.
                `.trim();
            } else if (matchCommand(command, ['ДОСЬЕ'], ['ДО'])) {
                const parts = command.split(' ');
                if (parts.length < 2) {
                    response = 'НЕВЕРНЫЙ ФОРМАТ КОМАНДЫ. ПРИМЕР: ДОСЬЕ АЛЕКСЕЕВ';
                    return response;
                }
                const surname = parts[1]; // Берем фамилию

                if (personnelDossiers[surname]) {
                    response = personnelDossiers[surname];
                } else {
                    response = `ДОСЬЕ НА СОТРУДНИКА ${surname} НЕ НАЙДЕНО.`;
                }
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ ПЕРСОНАЛА. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }

        function handleDataCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.DATA_MENU;
            } else if (matchCommand(fullCmd, ['БИОЛОГИЯ'], ['БИ'])) {
                response = 'БИОЛОГИЧЕСКИЕ ДАННЫЕ: ПОПУЛЯЦИЯ ПИНГВИНОВ, СОСТОЯНИЕ МОРСКИХ ОРГАНИЗМОВ.';
            } else if (matchCommand(fullCmd, ['ГЕОЛОГИЯ'], ['ГЕО'])) {
                response = 'ГЕОЛОГИЧЕСКИЕ ОТЧЕТЫ: СОСТАВ ГРУНТА, СЕЙСМИЧЕСКАЯ АКТИВНОСТЬ.';
            } else if (matchCommand(fullCmd, ['ГЛЯЦИОЛОГИЯ'], ['ГЛЯ'])) {
                response = 'ГЛЯЦИОЛОГИЧЕСКИЕ ДАННЫЕ: ТОЛЩИНА ЛЬДА, СКОРОСТЬ ДВИЖЕНИЯ ЛЕДНИКОВ.';
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ ДАННЫХ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }

        function handleExpeditionCommand(command) {
            let response = '';
            const fullCmd = command.split(' ')[0];

            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU.EXPEDITION_MENU;
            } else if (matchCommand(fullCmd, ['СТАТУС'], ['СТ'])) {
                response = 'АКТИВНЫЕ ЭКСПЕДИЦИИ: НЕТ. ПОСЛЕДНЯЯ: ИССЛЕДОВАНИЕ ПОБЕРЕЖЬЯ (ЗАВЕРШЕНА).';
            } else if (matchCommand(command, ['МАРШРУТ'], ['МАР'])) {
                const expNum = command.substring(command.indexOf(' ') + 1).trim();
                if (expNum === '1') {
                    response = `
МАРШРУТ ЭКСПЕДИЦИИ 1 "ИССЛЕДОВАНИЕ ПОБЕРЕЖЬЯ":
НАЧАЛО: СТАНЦИЯ БЕЛЛИНСГАУЗЕН.
ТОЧКА 1: БУХТА АДМИРАЛТЕЙСТВА (СБОР ОБРАЗЦОВ ФЛОРЫ).
ТОЧКА 2: ОСТРОВ КИНГ-ДЖОРДЖ, СЕВЕРНОЕ ПОБЕРЕЖЬЕ (ГЕОЛОГИЧЕСКИЕ ИЗМЕРЕНИЯ).
ТОЧКА 3: ЛЕДНИК ВИЛЬЯМС (ГЛЯЦИОЛОГИЧЕСКИЕ НАБЛЮДЕНИЯ).
ВОЗВРАЩЕНИЕ НА БАЗУ.
СТАТУС: ЗАВЕРШЕНА.
                    `.trim();
                } else if (expNum === '2') {
                    response = `
МАРШРУТ ЭКСПЕДИЦИИ 2 "ПОИСК ЗАПАДНЫХ ЛЕДНИКОВ":
НАЧАЛО: СТАНЦИЯ БЕЛЛИНСГАУЗЕН.
ТОЧКА 1: ОЗЕРО ВАНДА (СБОР ГИДРОЛОГИЧЕСКИХ ДАННЫХ).
ТОЧКА 2: ЗАПАДНЫЕ ПЛАТО (УСТАНОВКА СЕЙСМОГРАФОВ).
ТОЧКА 3: СКРЫТАЯ ЛЕДНИКОВАЯ ПЕЩЕРА (БИОЛОГИЧЕСКИЙ АНАЛИЗ).
ПЛАНИРУЕМОЕ ВОЗВРАЩЕНИЕ: ЧЕРЕЗ 72 ЧАСА.
СТАТУС: АКТИВНА.
                    `.trim();
                } else if (expNum === '3') {
                    response = `
МАРШРУТ ЭКСПЕДИЦИИ 3 "РАДИОЛОКАЦИОННОЕ ИССЛЕДОВАНИЕ":
НАЧАЛО: СТАНЦИЯ БЕЛЛИНСГАУЗЕН.
ТОЧКА 1: ВЫСОКОЕ ПЛАТО К ЮГУ (УСТАНОВКА РАДИОЛОКАТОРОВ).
ТОЧКА 2: МЫС МОЛОДЁЖИ (КАЛИБРОВКА ОБОРУДОВАНИЯ).
СТАТУС: ОЖИДАЕТ БЛАГОПРИЯТНЫХ ПОГОДНЫХ УСЛОВИЙ.
                    `.trim();
                } else if (!isNaN(expNum)) {
                    response = `МАРШРУТ ЭКСПЕДИЦИИ ${expNum}: ИДЕТ ЗАГРУЗКА ДАННЫХ. (ДЕТАЛЬНАЯ ИНФОРМАЦИЯ НЕДОСТУПНА).`;
                } else {
                    response = 'НЕВЕРНЫЙ НОМЕР ЭКСПЕДИЦИИ. ПРИМЕР: МАРШРУТ 1.';
                }
            } else if (matchCommand(command, ['ОТПРАВИТЬ'], ['ОТ'])) {
                if (!accessGranted) {
                    response = 'ТРЕБУЕТСЯ ДОСТУП ДЛЯ ОТПРАВКИ ЭКСПЕДИЦИИ.';
                } else {
                    const coords = command.substring(command.indexOf(' ') + 1).trim(); 
                    if (coords.toLowerCase() === SECRET_LAB_COORDS.toLowerCase()) {
                        if (!expeditionSentToLab) {
                            response = `ЭКСПЕДИЦИЯ ОТПРАВЛЕНА ПО КООРДИНАТАМ ${SECRET_LAB_COORDS}. ОЖИДАЙТЕ ОТЧЕТА.`;
                            commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО: ЭКСПЕДИЦИЯ ПО КООРДИНАТАМ ${SECRET_LAB_COORDS}`);
                            expeditionSentToLab = true;
                            setTimeout(() => {
                                inboxMessages.push(`${getTimestamp()} ОТЧЕТ ЭКСПЕДИЦИИ: НЕОПОЗНАННЫЙ ОБЪЕКТ НАЙДЕН. ТРЕБУЕТСЯ ДОПОЛНИТЕЛЬНОЕ ИССЛЕДОВАНИЕ.`);
                                sendResponseToType('ВХОДЯЩЕЕ СООБЩЕНИЕ'); 
                            }, 15000); // Задержка 15 секунд для отчета экспедиции
                        } else {
                            response = `ЭКСПЕДИЦИЯ ПО КООРДИНАТАМ ${SECRET_LAB_COORDS} УЖЕ ОТПРАВЛЕНА. ОЖИДАЙТЕ ОТЧЕТА.`;
                        }
                    } else if (coords.length > 5 && (coords.includes('N') || coords.includes('S')) && (coords.includes('E') || coords.includes('W'))) {
                         response = `ЭКСПЕДИЦИЯ ОТПРАВЛЕНА ПО КООРДИНАТАМ: ${coords}.`;
                         commsLog.push(`${getTimestamp()} ОТПРАВЛЕНО: ЭКСПЕДИЦИЯ ПО КООРДИНАТАМ ${coords}`);
                    } else {
                        response = 'НЕВЕРНЫЙ ФОРМАТ КООРДИНАТ. ПРИМЕР: ОТПРАВИТЬ 62.193S, 58.891W';
                    }
                }
            } else {
                response = 'НЕИЗВЕСТНАЯ КОМАНДА В МЕНЮ ЭКСПЕДИЦИИ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }
            return response;
        }


        // Главная функция обработки команды
        async function processCommand(commandText) { // Сделаем асинхронной
            let response = '';
            let responseHandledInternally = false; 
            const command = commandText.toUpperCase(); // Все команды в ВЕРХНЕМ регистре
            const fullCmd = command.split(' ')[0];

            // Обработка команды НАЗАД на любом уровне, кроме ROOT
            if (matchCommand(fullCmd, ['НАЗАД'], ['НА'])) {
                if (currentContext === 'FREY_MENU') {
                    currentContext = 'COMMS_MENU';
                    response = CONTEXT_MENU.COMMS_MENU;
                } else if (currentContext !== 'ROOT') {
                    currentContext = 'ROOT';
                    response = CONTEXT_MENU.ROOT;
                } else {
                    response = 'ВЫ УЖЕ В ГЛАВНОМ МЕНЮ.';
                }
                sendResponseToType(response);
                return;
            }

            // Обработка команды ПОМОЩЬ на любом уровне
            if (matchCommand(fullCmd, ['ПОМОЩЬ'], ['ПО'])) {
                response = CONTEXT_MENU[currentContext];
                sendResponseToType(response);
                return;
            }
            
            // Если доступ не разрешен, разрешена только команда КОД
            if (!accessGranted && currentContext === 'ROOT') {
                if (matchCommand(command, ['КОД'], ['КО'])) {
                    response = await handleRootCommand(command);
                } else {
                    response = 'ТРЕБУЕТСЯ ДОСТУП. ВВЕДИТЕ "КОД [КОД_ДОСТУПА]".';
                }
                sendResponseToType(response);
                return;
            }

            switch (currentContext) {
                case 'ROOT':
                    if (matchCommand(fullCmd, ['КАРТА'], ['КА'])) {
                        currentContext = 'MAP_MENU';
                        // Карта с неопознанным объектом показывается только если обе пеленгации получены
                        let currentMap = (freyBearingReceived && bellingshausenBearingReceived) ? MAP_ASCII_REVEALED : MAP_ASCII_INITIAL;
                        let legendResponse = `
ЛЕГЕНДА:
[Б] - БАЗА БЕЛЛИНСГАУЗЕНА (62°12′S 58°58′W)
[Ф] - БАЗА ФРЕЙ (62°11′S 58°56′W)
.   - ПОЛУОСТРОВ ФИЛЬДЕС
^   - ГОРЫ / ЛЕДНИКИ
~   - ПОБЕРЕЖЬЕ / МОРЕ
`;
                        if (freyBearingReceived && bellingshausenBearingReceived) { // Легенда [Н] только если обе пеленгации получены
                            legendResponse += `[Н] - НЕОПОЗНАННЫЙ ОБЪЕКТ (${SECRET_LAB_COORDS}) СИГНАЛ: ${secretSignalFrequency} МГЦ\n`;
                        }
                        legendResponse += `
МАСШТАБ: 10 СИМВОЛОВ ≈ 1 КМ
`;
                        
                        sendInstantResponseToOutput(`
ЗАГРУЗКА ТОПОГРАФИЧЕСКОЙ КАРТЫ:
${currentMap}
${legendResponse.trim()}
                        `.trim());
                        responseHandledInternally = true; 
                    } else {
                        response = await handleRootCommand(command);
                    }
                    break;
                case 'COMMS_MENU':
                    response = handleCommsCommand(command);
                    break;
                case 'FREY_MENU':
                    response = handleFreyCommand(command);
                    break;
                case 'POWER_MENU':
                    response = handlePowerCommand(command);
                    break;
                case 'WEATHER_MENU':
                    response = await handleWeatherCommand(command); // Асинхронный вызов
                    break;
                case 'MAP_MENU':
                    if (matchCommand(fullCmd, ['ОБЩАЯ'], ['ОБ'])) {
                        // Карта с неопознанным объектом показывается только если обе пеленгации получены
                        let currentMap = (freyBearingReceived && bellingshausenBearingReceived) ? MAP_ASCII_REVEALED : MAP_ASCII_INITIAL;
                        let legendResponse = `
ЛЕГЕНДА:
[Б] - БАЗА БЕЛЛИНСГАУЗЕНА (62°12′S 58°58′W)
[Ф] - БАЗА ФРЕЙ (62°11′S 58°56′W)
.   - ПОЛУОСТРОВ ФИЛЬДЕС
^   - ГОРЫ / ЛЕДНИКИ
~   - ПОБЕРЕЖЬЕ / МОРЕ
`;
                        if (freyBearingReceived && bellingshausenBearingReceived) { // Легенда [Н] только если обе пеленгации получены
                            legendResponse += `[Н] - НЕОПОЗНАННЫЙ ОБЪЕКТ (${SECRET_LAB_COORDS}) СИГНАЛ: ${secretSignalFrequency} МГЦ\n`;
                        }
                        legendResponse += `
МАСШТАБ: 10 СИМВОЛОВ ≈ 1 КМ
`;
                        
                        sendInstantResponseToOutput(`
ЗАГРУЗКА ТОПОГРАФИЧЕСКОЙ КАРТЫ:
${currentMap}
${legendResponse.trim()}
                        `.trim());
                        responseHandledInternally = true; 
                    } else {
                         response = handleMapCommand(command);
                    }
                    break;
                case 'PERSONNEL_MENU':
                    response = handlePersonnelCommand(command);
                    break;
                case 'DATA_MENU':
                    response = handleDataCommand(command);
                    break;
                case 'EXPEDITION_MENU':
                    response = handleExpeditionCommand(command);
                    break;
                default: // Добавлено для обработки отсутствующего SECRET_MENU
                    response = 'НЕИЗВЕСТНАЯ КОМАНДА В ТЕКУЩЕМ МЕНЮ. ВВЕДИТЕ "ПОМОЩЬ" ДЛЯ СПИСКА КОМАНД.';
            }

            // Только отправлять ответ, если он не был обработан внутренне
            if (!responseHandledInternally && response) { 
                sendResponseToType(response);
            }
        }


        // Обработчик ввода текста
        terminalActualInput.addEventListener('input', (e) => {
            inputValue = e.target.value.toUpperCase(); // Приводим к ВЕРХНЕМУ регистру
            e.target.value = inputValue; 
            updateUserInputDisplay();
            commandHistoryIndex = -1; 
        });

        // Обработчик нажатия клавиши Enter
        terminalActualInput.addEventListener('keypress', async (e) => { // Сделаем асинхронной
            if (e.key === 'Enter' && !isTypingResponse) {
                const commandText = inputValue.trim(); 
                addLineToOutput(`> ${commandText}`); // Пользовательский ввод без метки времени

                if (commandText !== '' && commandHistory[commandHistory.length - 1] !== commandText) {
                    commandHistory.push(commandText);
                }
                commandHistoryIndex = -1; 

                inputValue = ''; 
                terminalActualInput.value = ''; 
                updateUserInputDisplay(); 

                await processCommand(commandText); // Асинхронный вызов
            }
        });

        // Обработчик для стрелок вверх/вниз
        terminalActualInput.addEventListener('keydown', (e) => {
            if (isTypingResponse) {
                e.preventDefault();
                return;
            }
            
            if (e.key === 'ArrowUp') {
                e.preventDefault(); 
                if (commandHistory.length > 0) {
                    if (commandHistoryIndex === -1) {
                        if (inputValue !== '') {
                            if (commandHistory[commandHistory.length - 1] !== inputValue) {
                                commandHistory.push(inputValue); 
                                commandHistoryIndex = commandHistory.length - 1; 
                            } else {
                                commandHistoryIndex = commandHistory.length - 1;
                            }
                        } else {
                            commandHistoryIndex = commandHistory.length - 1;
                        }
                    } else if (commandHistoryIndex > 0) {
                        commandHistoryIndex--;
                    }
                    inputValue = commandHistory[commandHistoryIndex];
                    terminalActualInput.value = inputValue;
                    terminalActualInput.selectionStart = terminalActualInput.selectionEnd = inputValue.length; 
                    updateUserInputDisplay();
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (commandHistory.length > 0) {
                    if (commandHistoryIndex !== -1 && commandHistoryIndex < commandHistory.length - 1) {
                        commandHistoryIndex++;
                        inputValue = commandHistory[commandHistoryIndex];
                    } else if (commandHistoryIndex === commandHistory.length - 1) {
                        inputValue = '';
                        commandHistoryIndex = -1;
                    }
                    terminalActualInput.value = inputValue;
                    terminalActualInput.selectionStart = terminalActualInput.selectionEnd = inputValue.length; 
                    updateUserInputDisplay();
                }
            }
        });

        terminalActualInput.addEventListener('keyup', updateUserInputDisplay);
        terminalActualInput.addEventListener('mouseup', updateUserInputDisplay);

        // Инициализация при загрузке страницы
        window.addEventListener('load', () => {
            terminalActualInput.focus();
            updateUserInputDisplay(); // Первоначальное отображение курсора

            // Запускаем таймер для входящих сообщений
            setInterval(() => {
                if (!isTypingResponse && linesToTypeQueue.length === 0 && accessGranted) {
                    // Новое сюжетное сообщение от Центра
                    if (!freyRequestForBearingSent && Math.random() < 0.5) {
                        inboxMessages.push(`${getTimestamp()} ЦЕНТР: СРОЧНОЕ СООБЩЕНИЕ. ОБНАРУЖЕНЫ СИЛЬНЫЕ ПОМЕХИ В РАЙОНЕ ${SECRET_LAB_COORDS}. НЕ МОЖЕМ СВЯЗАТЬСЯ С ФРЕЙ. СВЯЖИТЕСЬ С ФРЕЙ И ЗАПРОСИТЕ ПЕЛЕНГ НА ${secretSignalFrequency} МГЦ.`);
                        sendResponseToType('ВХОДЯЩЕЕ СООБЩЕНИЕ'); 
                        freyRequestForBearingSent = true;
                        return;
                    }

                    // Общие случайные сообщения
                    if (Math.random() < 0.3) {
                        const messageOptions = [
                            'ВХОДЯЩИЙ СИГНАЛ ИЗ ЦЕНТРА: ПОДТВЕРДИТЕ СТАТУС БАЗЫ. ОЖИДАЕМ ОТВЕТ.',
                            'СООБЩЕНИЕ ОТ РЫБОЛОВЕЦКОГО ФЛОТА: ОБНАРУЖЕНЫ БОЛЬШИЕ СТАИ КРИЛЯ К ЮГУ.',
                            'ФРЕЙ СООБЩАЕТ: СИЛЬНАЯ МЕТЕЛЬ, ВИДИМОСТЬ ПОЧТИ НУЛЕВАЯ. БУДЬТЕ ОСТОРОЖНЫ.',
                            `ЦЕНТР: ОБНАРУЖЕН АНОМАЛЬНЫЙ СИГНАЛ В РАЙОНЕ ${SECRET_LAB_COORDS}. РЕКОМЕНДУЕМ ПЕЛЕНГАЦИЮ НА ${secretSignalFrequency} МГЦ.`
                        ];
                        const randomMessage = messageOptions[Math.floor(Math.random() * messageOptions.length)];
                        inboxMessages.push(`${getTimestamp()} ${randomMessage}`);
                        sendResponseToType('ВХОДЯЩЕЕ СООБЩЕНИЕ'); 
                    }
                } else if (!isTypingResponse && linesToTypeQueue.length === 0 && !accessGranted) {
                    // Случайные сообщения до получения доступа (реже)
                    if (Math.random() < 0.3) {
                         const messageOptions = [
                            'НЕИЗВЕСТНЫЙ СИГНАЛ... ПОМЕХИ...',
                            'СЛАБЫЙ ЗАКОДИРОВАННЫЙ СИГНАЛ...',
                            'ФОНОВЫЙ ШУМ. ИСТОЧНИК НЕОПРЕДЕЛЕН.'
                        ];
                        const randomMessage = messageOptions[Math.floor(Math.random() * messageOptions.length)];
                        inboxMessages.push(`${getTimestamp()} ${randomMessage}`);
                        sendResponseToType('ОБНАРУЖЕН СИГНАЛ. ТРЕБУЕТСЯ ДОСТУП ДЛЯ РАСШИФРОВКИ.');
                    }
                }
            }, 60000); // Проверять каждые 60 секунд (1 минута)

            // Запускаем таймер для расхода топлива
            setInterval(() => {
                if (accessGranted) {
                    if (generatorFuel[activeGenerator] > 0) {
                        generatorFuel[activeGenerator] = Math.max(0, generatorFuel[activeGenerator] - FUEL_CONSUMPTION_RATE);
                        // Опционально: если топливо заканчивается, вывести предупреждение
                        if (generatorFuel[activeGenerator] <= 10 && generatorFuel[activeGenerator] > 0.1 && linesToTypeQueue.length === 0) {
                             if (!inboxMessages.some(msg => msg.includes('НИЗКИЙ УРОВЕНЬ ТОПЛИВА'))) {
                                inboxMessages.push(`${getTimestamp()} ВНИМАНИЕ: НИЗКИЙ УРОВЕНЬ ТОПЛИВА В ГЕНЕРАТОРЕ ${activeGenerator}. ОСТАЛОСЬ ${generatorFuel[activeGenerator].toFixed(1)}%.`);
                                sendResponseToType('ВХОДЯЩЕЕ СООБЩЕНИЕ');
                             }
                        } else if (generatorFuel[activeGenerator] <= 0 && linesToTypeQueue.length === 0) {
                            if (!inboxMessages.some(msg => msg.includes('ТОПЛИВО ЗАКОНЧИЛОСЬ'))) {
                                inboxMessages.push(`${getTimestamp()} ВНИМАНИЕ: ТОПЛИВО В ГЕНЕРАТОРЕ ${activeGenerator} ЗАКОНЧИЛОСЬ! ТРЕБУЕТСЯ ПЕРЕКЛЮЧЕНИЕ.`);
                                sendResponseToType('ВХОДЯЩЕЕ СООБЩЕНИЕ');
                            }
                        }
                    }
                }
            }, 1000); // Расход топлива каждую секунду
        });

        // Потеря фокуса - вернуть фокус
        terminalActualInput.addEventListener('blur', () => {
            terminalActualInput.focus();
        });

    </script>
</body>
</html>
